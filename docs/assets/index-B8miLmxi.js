(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const o={geocoding:{baseUrl:"https://geocoding-api.open-meteo.com/v1",endpoints:{search:"/search"}},weather:{baseUrl:"https://api.open-meteo.com/v1",endpoints:{forecast:"/forecast"}}},h={favorites:"weather_favorites"},c={maxFavorites:3,updateIntervalMinutes:10},p={async getCityCoordinates(r){const e=`${o.geocoding.baseUrl}${o.geocoding.endpoints.search}?name=${r}&count=1&language=es`,n=await(await fetch(e)).json();if(!n.results||n.results.length===0)throw new Error("Ciudad no encontrada");return n.results[0]},async getCurrentWeather(r,e){const t=`${o.weather.baseUrl}${o.weather.endpoints.forecast}?latitude=${r}&longitude=${e}&current_weather=true`,s=await(await fetch(t)).json();return{temperature:s.current_weather.temperature,windSpeed:s.current_weather.windspeed,weatherCode:s.current_weather.weathercode}},async getWeatherByCity(r){const e=await this.getCityCoordinates(r),t=await this.getCurrentWeather(e.latitude,e.longitude);return{...e,...t}}};class m{constructor(e,t,n,s){this.name=e,this.country=t,this.latitude=n,this.longitude=s,this.currently_temp=null,this.lastUpdate=null,this.intervalId=null}async updateTemperature(){try{const e=await p.getCurrentWeather(this.latitude,this.longitude);return this.currently_temp=e.temperature,this.lastUpdate=new Date,this.currently_temp}catch(e){return console.error("Error al actualizar temperatura:",e),null}}startAutoUpdate(e=10){this.updateTemperature();const t=e*60*1e3;this.intervalId=setInterval(()=>{this.updateTemperature()},t)}stopAutoUpdate(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}}const i=[],d=()=>i,v=r=>i.some(t=>t.latitude===r.latitude&&t.longitude===r.longitude)?!1:(i.length>=c.maxFavorites&&i.shift().stopAutoUpdate(),i.push(r),y(),!0),y=()=>{const r=i.map(e=>({name:e.name,country:e.country,latitude:e.latitude,longitude:e.longitude,currently_temp:e.currently_temp,lastUpdate:e.lastUpdate}));localStorage.setItem(h.favorites,JSON.stringify(r))},g=()=>{const r=localStorage.getItem(h.favorites);if(r)try{JSON.parse(r).forEach(t=>{const n=new m(t.name,t.country,t.latitude,t.longitude);t.currently_temp!==null&&(n.currently_temp=t.currently_temp,n.lastUpdate=t.lastUpdate?new Date(t.lastUpdate):null),i.push(n)})}catch(e){console.error("Error al cargar favoritos:",e)}},f=(r,e)=>{r.innerHTML=`
        <div class="weather-card">
            <h2>${e.name}, ${e.country}</h2>
            <div class="temp">${e.temperature}°C</div>
            <p>Viento: ${e.windSpeed} km/h</p>
        </div>
    `},w=r=>{r.innerHTML='<p class="loading">Cargando...</p>'},u=(r,e)=>{r.innerHTML=`<p class="error">${e}</p>`},I=(r,e,t)=>{if(e.length===0){r.innerHTML='<p class="info">No tienes actividad frecuente aún. Busca una ciudad</p>';return}r.innerHTML=`
        <h3>Actividad reciente</h3>
        <div class="favorites-list">
            ${e.map((n,s)=>E(n)).join("")}
        </div>
    `,F(r,t)},E=(r,e)=>{const t=r.currently_temp!==null?`<span class="favorite-temp">${r.currently_temp.toFixed(1)}°C</span>`:"";return`
        <div class="favorite-item">
            <div class="favorite-info">
                <span class="favorite-name">${r.name}, ${r.country}</span>
                <span class="favorite-coords">${r.latitude.toFixed(2)}, ${r.longitude.toFixed(2)}</span>
                ${t}
            </div>
            <button class="quick-search" data-name="${r.name}">
                Ver clima
            </button>
        </div>
    `},F=(r,e)=>{r.querySelectorAll(".quick-search").forEach(t=>{t.addEventListener("click",n=>{const s=n.target.dataset.name;e(s)})})};class L{constructor(){this.elements={cityInput:document.getElementById("cityInput"),searchBtn:document.getElementById("searchBtn"),weatherResult:document.getElementById("weatherResult"),favoritesContainer:document.getElementById("favorites")}}init(){this.loadData(),this.attachEventListeners(),this.startAutoUpdates()}loadData(){g(),this.renderFavorites()}attachEventListeners(){this.elements.searchBtn.addEventListener("click",()=>this.handleSearch()),this.elements.cityInput.addEventListener("keypress",e=>{e.key==="Enter"&&this.handleSearch()})}async handleSearch(){const e=this.elements.cityInput.value.trim();if(!e){u(this.elements.weatherResult,"Por favor ingresa una ciudad");return}w(this.elements.weatherResult);try{const t=await p.getWeatherByCity(e);f(this.elements.weatherResult,t),this.saveFavorite(t),this.renderFavorites()}catch(t){u(this.elements.weatherResult,"Error al obtener el clima"),console.error("Error:",t)}}saveFavorite(e){const t=new m(e.name,e.country,e.latitude,e.longitude);v(t)&&t.startAutoUpdate(c.updateIntervalMinutes)}renderFavorites(){const e=d();I(this.elements.favoritesContainer,e,t=>this.quickSearch(t))}quickSearch(e){this.elements.cityInput.value=e,this.handleSearch()}startAutoUpdates(){d().forEach(t=>{t.startAutoUpdate(c.updateIntervalMinutes)}),setInterval(()=>{this.renderFavorites()},c.updateIntervalMinutes*60*1e3)}}document.addEventListener("DOMContentLoaded",()=>{new L().init()});
